---
- name: Drop any groovy scripts
  template:
    src: "{{ item }}.groovy"
    dest: "{{ jenkins_home }}/init.groovy.d/"
  when: item != 'skip'
  register: result_groovy
  with_items:
    - "{{ 'github_folder' if jenkins_deploy_gh_folder else 'skip' }}"
    - general_config
    - creds
    - "{{ 'ec2_cloud' if jenkins_deploy_ec2_clouds else 'skip' }}"
    - "{{ 'github_auth' if jenkins_deploy_gh_oauth else 'skip' }}"
    - "{{ 'slack' if jenkins_slack_settings else 'skip' }}"
  notify: restart jenkins

- name: Remove github folder lock if a new groovy script dropped
  file:
    path: "{{ jenkins_home }}/..disable-init_gh_folder"
    state: absent
  when: result_groovy.results[0].changed and jenkins_deploy_gh_folder

- name: Copy over static configuration files
  copy:
    dest: "{{ item.dest }}"
    src: "{{ item.src|default(omit) }}"
    content: "{{ item.content|default(omit) }}"
    owner: jenkins
    group: jenkins
    mode: 0400
  notify: restart jenkins
  with_items: "{{ jenkins_static_configs }}"

- name: Ensure jenkins creds sshdirectory exists
  file:
    state: directory
    path: "{{ jenkins_home }}/.ssh/"
    owner: jenkins
    group: jenkins
    mode: 0700

- name: Copy over any ssh config files
  copy:
    content: "{{ item.privkey }}"
    dest: "{{ jenkins_home }}/.ssh/{{ item.keyname }}"
    owner: jenkins
    group: jenkins
    mode: 0700
  no_log: true
  register: register_copyssh
  with_items: "{{ jenkins_deploy_ssh_files }}"
